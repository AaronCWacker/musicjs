<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Random chord sequence v2</title>
  <script src="abc.js"></script>
  <script src="rand.js"></script>
  <script src="rng.js"></script>
  <script>
    const rng = new Rng()
    const f = (r) => {
      console.log(`New seed cb: ${r.seed}`)
    }
    rng.add_new_seed_callback(f)
    rng.new_seed(1)
  </script>
  <script>
    // seed control ui generated programmatically
    // RngControls manages the seed, manages triggering
    // updates. So when a new seed is set, RngControls
    // updates its own copy of the seed, calls new_seed
    // on the Rng, and then calls a callback given
    // to it by the music renderer.
    class RngControls {
      constructor(rng,div_id) {
        // this needs refactoring
        this.target = document.getElementById(div_id)
        this.use_sharps = false
        this.rng = rng
        rng.add_new_seed_callback(this.update_seed)
        this.callbacks = []
        if(!this.target) {
          throw new Error(`Element with id ${div_id} does not exist`)
        }
        this.create_ui()
        this.map_keys()
        this.update_seed()
        this.seed_input.focus()
      }
      map_keys() {        
        this.key_dict = {
          "s": () => { this.toggle_use_sharps() },
          "a": () => { console.log("hello") },
          "i": () => { this.seed_input.focus() }
        }
        window.addEventListener("keypress",this.key_handler)
      }
      key_handler = (e) => {
        const key = e.key
        if( key in this.key_dict ) {
          this.key_dict[key](e)
        }
      }
      add_callback(cb) {
        this.callbacks.push(cb)
      }
      signal_callbacks() {
        this.callbacks.forEach(cb => cb(this))
      }
      create_ui() {
        console.log("create ui")
        const target = this.target
        const crdiv = (id,content,classes=[],cb) => {
          let div
          div = document.createElement("div")
          div.setAttribute("id",id)
          div.classList.add('seed_button')
          classes.forEach(cls => div.classList.add(cls))
          div.addEventListener("click",(e) => { e.preventDefault(); cb(e); })
          div.textContent = content
          target.append(div)
        }

        crdiv("ui_s_m100","-100",["seed_minus"], (e) => this.add(-100))
        crdiv("ui_s_m10","-10",["seed_minus"], (e) => this.add(-10))
        crdiv("ui_s_m1","-1",["seed_minus"], (e) => this.add(-1))

        crdiv("ui_s_p1","+1",["seed_plus"], (e) => this.add(+1))
        crdiv("ui_s_p10","+10",["seed_plus"], (e) => this.add(+10))
        crdiv("ui_s_p100","+100",["seed_plus"], (e) => this.add(+100))

        crdiv("ui_s_daily","Daily",["seed_daily"], (e) => this.daily())

        crdiv("ui_s_random","Random",["seed_random"], (e) => this.random())
        crdiv("ui_s_zero","Zero",["seed_zero"], (e) => this.zero())

        let div
        target.append(document.createElement("br"))
    
        div = document.createElement("div")
          let input = document.createElement("input")
            input.setAttribute("type","number")
            input.setAttribute("id","ui_seed")
            input.setAttribute("value",0)
            input.addEventListener("change",(e) => this.rng.new_seed(e.target.value))
            div.append(input)
            this.seed_input = input
          
          let text
            text = document.createTextNode("(Current seed: ")
            div.append(text)
        
          let span
            span = document.createElement("span")
            span.textContent = this.rng.seed
            this.current_seed_element = span
            div.append(span)
        
            text = document.createTextNode(")")
            div.append(text)
        target.append(div)
      }
      toggle_use_sharps() {
        this.use_sharps = !this.use_sharps
        this.signal_callbacks()
      }
      update_seed = (n) => {
        const seed = this.rng.seed
        this.current_seed_element.textContent = seed
        this.seed_input.value = seed
        this.signal_callbacks()
      }
      add(n) {
        this.rng.new_seed(this.rng.seed+n)
      }
      daily() {
        const now = Date.now()
        const epoch = Date.parse('1 Jan 2020')
        const days = Math.floor((now - epoch)/(1000*24*3600))
        this.rng.new_seed(days*100); 
      }
      random() {
        const seed_random_range = 10**7
        this.rng.new_seed(Math.floor(Math.random()*seed_random_range))
      }
      zero() {
        this.rng.new_seed(0)
      }
      get_seed() {
        return this.rng.seed
      }
    }
  </script>
  <script>
    class AbcGenerator {
      constructor(rng,ui,paper) {
        this.rng = rng
        this.ui = ui
        this.paper = paper
      }
      generate() {
        const abc = this.generate_abc()
        ABCJS.renderAbc(this.paper,abc,{responsive:"resize"})
      }
      generate_abc() {
        const sample_abc = `
  X:1
  M:12/8
  L:1/8
  K:clef=bass
  CCCC CCCC|DDDD DEFG|]      
       `
        return sample_abc
      }
    }
    class MyGenerator extends AbcGenerator {
      generate_abc() {
        const sample_abc = `
  X:1
  M:12/8
  L:1/8
  K:clef=treble
  CCCC CCCC|DDDD DEFG|]      
       `
        return sample_abc
      }
    }
  </script>
  <script>
    // const rng = new Rng()
    let ui
    let paper
    let generator
    const g = (x) => { 
      const seed = x.get_seed()
      console.log(42,{x},seed) 

      // generate and show from here
      generator.generate()
    }
    // thinking is that we subclass AbcGenerator

    window.addEventListener("load",() => {
      ui = new RngControls(rng,"ui")
      paper = document.getElementById("paper")
      generator = new MyGenerator(rng,ui,paper) // generator adds its generate() callback -- later
      ui.add_callback(g)
      g(ui)

    })
  </script>
  <style>
div.seed_button {
  display: inline-block;
  padding: 0.5em;
  margin: 0.5em;
  border: 1px solid black;
  cursor: pointer;
}
div.seed_minus {
  background-color: #fcc;
}
div.seed_plus {
  background-color: #cfc;
}
div.seed_daily {
  background-color: #ccf;
}
div.seed_random {
  background-color: #fcf;
}
div.seed_zero {
  background-color: #ccc;
}
  </style>
</head>
<body>
  <div id="ui"></div>
  <div id="paper"></div>
</body>
</html>